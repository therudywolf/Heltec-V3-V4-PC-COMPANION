# NOCTURNE OS — WolfPet

**Ветка:** `WolfPet` · **Платформа:** Heltec WiFi LoRa 32 V4 (ESP32-S3) · **Лицензия:** [MIT](LICENSE)

![License](https://img.shields.io/badge/license-MIT-green) ![Platform](https://img.shields.io/badge/platform-ESP32--S3-blue) ![Branch](https://img.shields.io/badge/branch-WolfPet-orange)

> _"In the silence of the net, the wolf hunts alone."_

Прошивка **Nocturne OS** превращает **Heltec V4** в кибердек-монитор: OLED 128×64, телеметрия по TCP с ПК, тактическое меню, утилиты (Wi‑Fi сканер, Deauth, BLE Spam, USB HID, портал, Vault, Daemon) и система алертов по температуре/нагрузке/ОЗУ.

---

## Содержание

- [Возможности](#-возможности)
- [Железо](#-железо)
- [Экраны (сцены)](#-экраны-сцены)
- [Управление](#-управление)
- [Меню](#-меню)
- [Утилиты (Tools)](#-утилиты-tools)
- [Алерты (RED ALERT)](#-алерты-red-alert)
- [Установка](#-установка)
- [Конфигурация](#-конфигурация)
- [Структура проекта](#-структура-проекта)
- [Опционально: LoRa](#-опционально-lora)
- [Авторы и лицензия](#-авторы-и-лицензия)

---

## Возможности

| Область     | Описание                                                                                          |
| ----------- | ------------------------------------------------------------------------------------------------- |
| **Дизайн**  | Единая сетка 2×2, Tech Brackets, chamfered boxes, ProFont10 / HelvB10, ~60 FPS, glitch-эффекты.   |
| **Связь**   | WiFi без power-saving (`WIFI_PS_NONE`), автореконнект, таймауты и grace period в `config.h`.      |
| **Меню**    | Двухуровневое (категории → подменю), под хедером, подсказка внизу, сохранение в NVS.              |
| **Утилиты** | Полноэкранные режимы без глобального хедера: RADAR, DEAUTH, BLE, USB HID, PORTAL, VAULT, DAEMON.  |
| **Алерты**  | Пороги по CPU/GPU temp и load, ОЗУ по гигабайтам; двойной blink LED, подсветка метрики на экране. |
| **Яркость** | Долгое нажатие вне меню переключает нормальную/пониженную яркость (контраст 12).                  |

---

## Железо

| Компонент        | Параметр                     | Примечание                            |
| ---------------- | ---------------------------- | ------------------------------------- |
| **Плата**        | Heltec WiFi LoRa 32 V4       | ESP32-S3R2                            |
| **Дисплей**      | 0.96" OLED SSD1306           | I2C: SDA 17, SCL 18, RST 21           |
| **Питание OLED** | Vext GPIO 36                 | LOW = включено                        |
| **Кнопка**       | GPIO 0 (PRG)                 | Pull-up, короткое/долгое/двойной тап  |
| **LED**          | GPIO 35 (белый)              | Алерты, predator breath               |
| **Батарея**      | ADC GPIO 1, контроль GPIO 37 | Делитель 4.9, калибровка в `config.h` |
| **I2C**          | 800 kHz                      | Для стабильного 60 FPS                |

---

## Экраны (сцены)

В режиме **Normal** (мониторинг с ПК) доступны 9 сцен; переключение — короткое нажатие (карусель сбрасывается).

| №   | Сцена       | Содержимое                                           |
| --- | ----------- | ---------------------------------------------------- |
| 0   | **MAIN**    | CPU/GPU темпы и загрузка, RAM, lifebar               |
| 1   | **CPU**     | Ядро, температура, частота, нагрузка, мощность       |
| 2   | **GPU**     | Температура, частота, нагрузка, VRAM                 |
| 3   | **RAM**     | Топ процессов по памяти, общее использование         |
| 4   | **DISKS**   | Сетка 2×2: буква диска, температура                  |
| 5   | **MEDIA**   | Трек/исполнитель (прокрутка), статус воспроизведения |
| 6   | **FANS**    | RPM и % для CPU, Pump, GPU, Case                     |
| 7   | **MB**      | Материнская плата: VRM, Chipset и др.                |
| 8   | **WEATHER** | Иконка погоды (XBM), температура                     |

---

## Управление

Одна кнопка (GPIO 0):

| Действие            | В обычном режиме            | В меню                            |
| ------------------- | --------------------------- | --------------------------------- |
| **Короткое** (<1 s) | Следующая сцена             | Следующий пункт меню              |
| **Долгое** (>1 s)   | Вкл/выкл пониженной яркости | Выбор / вход / выполнение         |
| **Двойной тап**     | Открыть меню                | Назад из подменю или закрыть меню |

**Predator:** в нормальном режиме очень долгое нажатие (~2.5 s) включает режим «хищник»: экран гаснет, LED «дышит». Повтор — выход.

---

## Меню

- **Открытие:** двойной тап по кнопке.
- **Навигация:** короткое нажатие — следующий пункт.
- **Выбор:** долгое нажатие — войти в категорию или выполнить действие.
- **Назад/закрытие:** двойной тап (из подменю — назад, с уровня категорий — выход из меню).

Внизу окна меню подсказка: `1x next  2s ok  2x back`.

### Структура меню

| Категория  | Пункты                           | Действия                                                                                                                                                 |
| ---------- | -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Config** | AUTO, FLIP, GLITCH, LED, DIM     | AUTO: цикл OFF → 5 s → 10 s → 15 s → OFF. FLIP: поворот 180°. GLITCH: вкл/выкл. LED: подсветка. DIM: низкая яркость по умолчанию. Все сохраняются в NVS. |
| **WiFi**   | SCAN, DEAUTH, PORTAL             | Переход в RADAR, Deauth, Captive Portal (AP **MT_FREE**).                                                                                                |
| **Tools**  | BLE SPAM, USB HID, VAULT, DAEMON | BLE Spam, BadWolf USB HID, TOTP Vault, экран Daemon (Wolf + телеметрия).                                                                                 |
| **System** | REBOOT, VERSION, EXIT            | Перезагрузка (с подтверждением), показ версии (v1.0), выход из меню.                                                                                     |

Настройки Config и яркость сохраняются в NVS.

---

## Утилиты (Tools)

Режимы из меню **WiFi** и **Tools** рисуются **на весь экран без глобального хедера** (больше места под контент).

| Режим                 | Описание                                                                                                                                  |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| **RADAR**             | Wi‑Fi сканер: список сетей, RSSI, канал, тип шифрования; короткое нажатие — рескан/выбор.                                                 |
| **DEAUTH**            | Цель из скана, deauth-пакеты; статус INJECTING/IDLE, счётчик пакетов. Если устройства не отключаются — см. подраздел ниже про патч ESP32. |
| **BLE SPAM**          | NimBLE spam; счётчик пакетов, glitch при смене payload.                                                                                   |
| **USB HID** (BadWolf) | Режим USB HID (клавиатура).                                                                                                               |
| **PORTAL**            | Точка доступа + captive portal; имя сети по умолчанию **MT_FREE**; логи и пароли.                                                         |
| **VAULT**             | TOTP 2FA: аккаунт, 6-значный код, таймер.                                                                                                 |
| **DAEMON**            | Экран «Wolf Soul»: анимация волка + CPU/GPU/RAM, без хедера.                                                                              |

Выход из любого режима утилит: **двойной тап** → открывается меню, затем с уровня категорий снова двойной тап — закрытие меню и возврат в нормальный режим (или пункт EXIT в System).

### DEAUTH: почему атака может не отключать устройства

- **Драйвер ESP32 блокирует deauth.** В стандартной прошивке Espressif функция `esp_wifi_80211_tx()` фильтрует кадры деаутентификации (тип 0xC0), поэтому пакеты не уходят в эфир. Счётчик PKTS может расти, но клиенты не дисконектятся.
- **Решение:** применить патч к библиотеке Wi‑Fi (замена объектного файла в `libnet80211.a`). Пример: [esp32_deauth_patch](https://github.com/Hex2424/esp32_deauth_patch) (ESP-IDF / Arduino). Для **ESP32-S3** и **PlatformIO** (espressif32 6.x) нужно подобрать или собрать подходящий патч под свою версию платформы.
- **Дополнительно:** не сработает против сетей с **Protected Management Frames** (802.11w / WPA3); цель должна быть в **2.4 GHz** (ESP32 не поддерживает 5 GHz). При входе в режим DEAUTH прошивка отключается от текущей точки доступа, чтобы не мешать инъекции.

---

## Алерты (RED ALERT)

Сервер (`monitor.py`) при превышении порогов отправляет `alert: "CRITICAL"` и `alert_metric`. Устройство:

- мигает белым LED **ровно 2 раза**;
- переключает экран на нужную сцену (CPU/GPU/RAM);
- подсвечивает проблемную метрику (температура/нагрузка/RAM);
- рисует толстую рамку по краям экрана (RED ALERT overlay).

Пороги задаются в **`server/monitor.py`** (и при необходимости дублируются в **`include/nocturne/config.h`** для справки):

| Метрика   | Порог                    | Гистерезис (сброс) |
| --------- | ------------------------ | ------------------ |
| CPU temp  | 87 °C                    | −5 °C              |
| GPU temp  | 68 °C                    | −5 °C              |
| CPU load  | 90 %                     | −5 %               |
| GPU load  | 100 %                    | −5 %               |
| VRAM load | 95 %                     | −5 %               |
| **RAM**   | **30 ГБ** (использовано) | &lt; 28 ГБ         |

---

## Установка

### Требования

- **Прошивка:** VS Code + PlatformIO, проект открыт по корню репозитория.
- **Сервер на ПК:** Python 3.x, зависимости из `server/requirements.txt`.
- **Телеметрия:** [Libre Hardware Monitor](https://github.com/LibreHardwareMonitor/LibreHardwareMonitor/releases) — запуск **от имени администратора**, в настройках включён **Remote Web Server** (порт 8085 по умолчанию).

### Прошивка устройства

1. Клонировать репозиторий, открыть в VS Code.
2. Скопировать `include/secrets.h.example` в `include/secrets.h`, прописать Wi‑Fi и IP ПК:
   ```cpp
   #define WIFI_SSID "YourNetwork"
   #define WIFI_PASS "YourPassword"
   #define PC_IP     "192.168.1.2"
   #define TCP_PORT  8888
   ```
3. Подключить Heltec V4 по USB-C, выполнить **PlatformIO: Upload**.

### Сервер на ПК (монитор)

Всё, что относится к серверу телеметрии, находится в папке **`server/`**.

```bash
cd server
pip install -r requirements.txt
```

При необходимости отредактировать `server/config.json` (хост, порт, `lhm_url`, город для погоды). Запуск:

```bash
cd server
python monitor.py
```

Варианты:

- **С треем (по умолчанию):** иконка в трее, пункты: Add/Remove startup, Restart Server, Close.
- **Без трея:** `python monitor.py --no-tray` или `--console` (логи в консоль).

Логи пишутся в `nocturne.log` в корне проекта (или рядом с exe при сборке в один файл).

### Сборка exe (Windows)

Из папки **`server/`**: запустить `build_server.bat` — установка зависимостей, сборка exe, копирование `config.json` в `dist/`. Результат: **`server/dist/NocturneServer.exe`**.

---

## Конфигурация

| Файл                            | Назначение                                                                                |
| ------------------------------- | ----------------------------------------------------------------------------------------- |
| **`include/secrets.h`**         | Wi‑Fi SSID/пароль, IP ПК, TCP-порт. Не коммитить.                                         |
| **`include/nocturne/config.h`** | Пины, размеры экрана, таймауты, пороги алертов (для справки), параметры меню и батареи.   |
| **`server/config.json`**        | Сервер: `host`, `port`, `lhm_url`, `limits`, `weather_city`. Рядом с exe или в `server/`. |

Пример `config.json`:

```json
{
  "host": "0.0.0.0",
  "port": 8090,
  "lhm_url": "http://localhost:8085/data.json",
  "limits": { "gpu": 72, "cpu": 85 },
  "weather_city": "London"
}
```

**Формат и значения по умолчанию:** при отсутствии файла или полей используются: `host` = `"0.0.0.0"`, `port` = `8090`, `lhm_url` = `"http://localhost:8085/data.json"`, `limits` = `{"gpu": 80, "cpu": 75}`, `weather_city` = `"Moscow"`. Поле `limits` задаёт пороги алертов (в °C для gpu/cpu при использовании в логике монитора; точные пороги см. в `monitor.py` и `config.h`).

Порт в `config.json` должен совпадать с `TCP_PORT` в `secrets.h` (или с тем портом, на котором реально слушает монитор).

---

## Структура проекта

```
├── include/
│   ├── nocturne/
│   │   ├── config.h      # Пины, экран, меню, алерты, сцены
│   │   └── Types.h      # Типы состояния
│   └── secrets.h.example # Шаблон → копировать в secrets.h
├── server/              # Сервер телеметрии (ПК)
│   ├── monitor.py       # TCP-сервер: LHM, погода, медиа, алерты, трей
│   ├── build_server.bat # Сборка → server/dist/NocturneServer.exe
│   ├── NocturneServer.spec
│   ├── requirements.txt
│   └── config.json
├── src/
│   ├── main.cpp         # Точка входа: WiFi, кнопка, меню, сцены, утилиты
│   └── modules/
│       ├── DisplayEngine.*   # Буфер, примитивы, хедер, glitch, RED ALERT
│       ├── SceneManager.*    # 9 сцен + меню + все утилиты (RADAR, Kick, BLE, …)
│       ├── NetManager.*     # WiFi, TCP, парсинг JSON, таймауты
│       ├── BootAnim.*       # Заставка при старте
│       ├── TrapManager.*    # AP + captive portal (MT_FREE)
│       ├── KickManager.*    # Deauth
│       ├── BleManager.*     # BLE Spam
│       ├── UsbManager.*     # USB HID (BadWolf)
│       ├── VaultManager.*   # TOTP
│       └── RollingGraph.*   # Графики (sparkline)
├── tests/               # Unit-тесты (monitor: config, payload)
├── platformio.ini       # Сборка ESP32 (env heltec_wifi_lora_32_V4, профиль V3 под железо V4)
├── DataSheets/         # PDF платы
└── optional/radio/     # LoRa (SX1262) — вынесено, подключается при необходимости
```

В репозитории нет: `secrets.h`, `.env`, `.pio/`, артефактов сборки, логов.

---

## Опционально: LoRa

Радиомодуль SX1262 (LoRa/FSK) вынесен в `optional/radio/` для экономии Flash/RAM. Инструкция по возврату режимов LoRa (MESH, JAM, SENSE), пины и зависимости — в **`optional/radio/README.md`**.

---

## Авторы и лицензия

- **Концепция и код:** RudyWolf
- **Оформление:** Nocturne / WolfPet
- **Библиотеки:** U8g2 (Olikraus), ArduinoJson (Bblanchon), NimBLE-Arduino (h2zero)

**Лицензия:** [MIT](LICENSE).

---

_End of Transmission._
