# NOCTURNE OS (v4.2.0) — ветка main

**Высокопроизводительная прошивка-кибердек для Heltec WiFi LoRa 32 V4**

![Лицензия](https://img.shields.io/badge/license-MIT-green) ![Платформа](https://img.shields.io/badge/platform-ESP32--S3-blue) ![Статус](https://img.shields.io/badge/status-STABLE-brightgreen)

> _«В тишине сети волк охотится один.»_

**Nocturne OS** — прошивка для платы **Heltec V4**. Устройство работает как монитор телеметрии ПК: получает данные по TCP, выводит их на OLED 128×64, показывает сцены (CPU, GPU, RAM, диски, медиа, вентиляторы, матплата, погода), тактическое меню и систему алертов.

Ориентир на **внешний вид**, **низкую задержку** и **надёжность связи**.

---

## Содержание

- [Основные возможности](#-основные-возможности)
- [Железо](#-железо)
- [Экраны (сцены)](#-экраны-сцены)
- [Управление](#-управление)
- [Меню](#-меню)
- [Алерты](#-алерты)
- [Установка](#-установка)
- [Структура проекта](#-структура-проекта)
- [Авторы и лицензия](#-авторы-и-лицензия)

---

## Основные возможности

### 1. Единая сетка (Unified Grid)

Единый пиксель-перфектный сеточный макет для сцен CPU, GPU и материнской платы.

- **Tech Brackets** — примитивы в виде рамок под данные (как HUD).
- **Chamfered Boxes** — скруглённые блоки для меню и заголовков.
- **Шрифты** — ProFont10 (данные) и HelvB10 (заголовки) для читаемости на 0.96" OLED.

### 2. Связь (Iron Grip)

WiFi без перехода в режим энергосбережения, быстрый реконнект.

- **Режим радио:** `esp_wifi_set_ps(WIFI_PS_NONE)` — максимальная отзывчивость.
- **Задержка:** обновления за доли секунды, плавные графики.
- **Реконнект:** автоматическое переподключение при обрыве, настраиваемые таймауты.

### 3. Алерты (Stealth Hunter)

Сервер при превышении порогов отправляет состояние `CRITICAL`. Устройство:

- мигает белым LED **ровно 2 раза**;
- переключает экран на нужную сцену и подсвечивает метрику;
- после этого LED не мигает бесконечно — только визуальная подсветка на экране.

### 4. Тактическое меню

Меню поверх сцен: карусель экранов, поворот дисплея, выход. Настройки сохраняются в NVS.

- **AUTO** — автопереключение сцен (5 s → 10 s → 15 s → выкл).
- **FLIP** — поворот экрана на 180° (удобно по расположению кабеля).
- **EXIT** — выход из меню.

---

## Железо

| Компонент    | Параметр                     | Примечание              |
| ------------ | ---------------------------- | ----------------------- |
| **Плата**    | Heltec WiFi LoRa 32 V4       | MCU ESP32-S3R2          |
| **Дисплей**  | 0.96" OLED SSD1306           | I2C: SDA 17, SCL 18     |
| **Тактовая** | 240 MHz (CPU), 800 kHz (I2C) | I2C разогнан под 60 FPS |
| **LED**      | GPIO 25 (белый)              | Алерты                  |
| **Кнопка**   | GPIO 0 (PRG)                 | Ввод (pull-up)          |

---

## Экраны (сцены)

| №   | Сцена       | Содержимое                                          |
| --- | ----------- | --------------------------------------------------- |
| 1   | **MAIN**    | Сводка: температуры CPU/GPU, полоски загрузки, RAM. |
| 2   | **CPU**     | Температура ядра, частота, нагрузка, мощность.      |
| 3   | **GPU**     | Температура, частота, нагрузка, использование VRAM. |
| 4   | **RAM**     | Топ процессов по памяти, общее использование.       |
| 5   | **DISKS**   | Сетка 2×2: буква диска и температура.               |
| 6   | **MEDIA**   | Текущий трек и исполнитель (с прокруткой).          |
| 7   | **FANS**    | Обороты и % для CPU, помпы, GPU, корпуса.           |
| 8   | **MB**      | Датчики матплаты (VRM, чипсет и т.д.).              |
| 9   | **WEATHER** | Иконка погоды (XBM) и крупная температура.          |

---

## Управление

Одна кнопка (GPIO 0):

| Действие               | В обычном режиме | В меню               |
| ---------------------- | ---------------- | -------------------- |
| **Короткое** (<1 s) | Следующая сцена  | Следующий пункт меню |
| **Долгое** (>1 s)   | Открыть меню     | Выбор / изменение    |

Переключение сцен сбрасывает таймер карусели (если AUTO включён).

---

## Меню

- **Открытие:** долгое нажатие в обычном режиме.
- **Пункты:** AUTO (цикл 5 / 10 / 15 с или выкл), FLIP (поворот 180°), EXIT (закрыть меню).
- **Навигация:** короткое нажатие — следующий пункт.
- **Выбор:** долгое нажатие — применить (AUTO/FLIP) или выход (EXIT).

Настройки сохраняются в энергонезависимую память (NVS).

---

## Алерты

Пороги задаются на стороне сервера (`monitor.py`) и в `config.h` (для согласованности). При превышении сервер отправляет `CRITICAL` и идентификатор метрики; устройство мигает LED два раза и подсвечивает соответствующую сцену и значение.

Типичные пороги (в коде): температура CPU 87 °C, GPU 68 °C, загрузка CPU/GPU 99 %, VRAM 95 %, RAM 90 %.

---

## Установка

### Что нужно

- **Прошивка:** VS Code с PlatformIO.
- **Сервер на ПК:** Python 3.x.
- **Телеметрия:** [Libre Hardware Monitor](https://github.com/LibreHardwareMonitor/LibreHardwareMonitor/releases) — запуск **от имени администратора**, в настройках включён **Remote Web Server** (порт 8085 по умолчанию).

### Прошивка устройства

1. Клонировать репозиторий и открыть его в VS Code.
2. Скопировать `include/secrets.h.example` в `include/secrets.h` и указать Wi‑Fi и IP ПК:
   ```cpp
   #define WIFI_SSID "ВашаСеть"
   #define WIFI_PASS "Пароль"
   #define PC_IP     "192.168.1.100"
   #define TCP_PORT  8888
   ```
3. Подключить Heltec V4 по USB-C.
4. Выполнить **PlatformIO: Upload**.

### Запуск монитора на ПК

```bash
pip install -r requirements.txt
```

При необходимости отредактировать `config.json` (хост, порт, URL LHM, город для погоды). Запуск:

```bash
python src/monitor.py
```

Сервер отдаёт по TCP JSON с телеметрией (LHM, погода, медиа). Порт в `config.json` должен совпадать с `TCP_PORT` в `secrets.h`.

---

## Структура проекта

```
├── include/
│   ├── nocturne/         # config.h, Types.h
│   └── secrets.h.example # шаблон → копировать в secrets.h (не коммитить)
├── src/
│   ├── main.cpp          # точка входа прошивки
│   ├── monitor.py        # TCP-сервер на ПК (LHM, погода, медиа)
│   └── modules/          # DisplayEngine, SceneManager, NetManager,
│                         # BootAnim, RollingGraph
├── config.json           # хост, порт, lhm_url, погода
├── platformio.ini        # сборка под ESP32 (Heltec V3 profile для платы V4)
├── requirements.txt      # зависимости Python для монитора
└── NocturneServer.spec   # PyInstaller для сборки exe
```

В репозитории нет: `secrets.h`, `.env`, `.pio/`, артефактов сборки и логов.

---

## Авторы и лицензия

- **Концепция и код:** RudyWolf
- **Оформление:** Nocturne Cyberpunk System
- **Библиотеки:** U8g2 (Olikraus), ArduinoJson (Bblanchon)

**Лицензия:** [MIT](LICENSE)

---

_Конец передачи._
